# Digikala Product Importer v2.0.0

## توضیحات
این افزونه امکان وارد کردن محصولات از دیجی‌کالا به ووکامرس را با ویژگی‌های پیشرفته فراهم می‌کند.

## ویژگی‌های جدید ورژن 2.0.0

### ✨ قابلیت‌های اصلی
- **ورود تکی محصولات** با پیش‌نمایش کامل
- **ورود گروهی محصولات** از یک دسته‌بندی
- **فیلتر بر اساس برند** در ورود گروهی
- **هماهنگ‌سازی خودکار قیمت‌ها** دو بار در روز
- **پشتیبانی کامل از محصولات متغیر** (رنگ‌های مختلف)
- **حذف تکراری‌ها** برای محصولات با رنگ یکسان

### 🔧 بهبودهای فنی
- **SKU محصولات**: شناسه دیجی‌کالا به عنوان SKU
- **دسته‌بندی هوشمند**: ایجاد خودکار سلسله مراتب دسته‌بندی‌ها
- **مدیریت برندها**: تاکسونومی اختصاصی برای برندها
- **تگ‌گذاری خودکار**: اضافه کردن تگ‌های محصول از دیجی‌کالا
- **بهینه‌سازی تصاویر**: دانلود و ذخیره تصاویر با کیفیت

## ساختار فایل‌ها

```
digikala-product-importer/
├── digikala-product-importer.php      # فایل اصلی افزونه
├── includes/
│   └── helper-functions.php           # توابع کمکی
├── assets/
│   ├── admin.css                      # استایل‌های مدیریت
│   └── admin.js                       # جاوااسکریپت مدیریت
├── templates/
│   ├── admin-page.php                 # صفحه ورود تکی
│   ├── bulk-import-page.php           # صفحه ورود گروهی
│   ├── price-sync-page.php            # صفحه هماهنگ‌سازی قیمت
│   └── product-preview.php            # پیش‌نمایش محصول
├── languages/                         # فایل‌های ترجمه
└── README.md                          # مستندات
```

## نصب و راه‌اندازی

### پیش‌نیازها
- ✅ WordPress 5.0 یا بالاتر
- ✅ WooCommerce 5.0 یا بالاتر
- ✅ PHP 7.4 یا بالاتر
- ✅ افزونه cURL فعال
- ✅ مجوز نوشتن در پوشه uploads

### مراحل نصب
1. فایل‌های افزونه را در پوشه `/wp-content/plugins/digikala-product-importer/` قرار دهید
2. افزونه را از پنل مدیریت فعال کنید
3. از منوی "وارد کردن از دیجی‌کالا" استفاده کنید

## راهنمای استفاده

### ورود تکی محصول

1. **دریافت لینک محصول**
   ```
   https://www.digikala.com/product/dkp-12345678/
   ```

2. **وارد کردن لینک** در صفحه ورود تکی

3. **بررسی پیش‌نمایش** و انتخاب تنظیمات:
   - انتخاب متغیرها (رنگ‌ها)
   - تنظیم قیمت‌ها
   - انتخاب مشخصات فنی
   - تنظیمات تصاویر

4. **وارد کردن محصول**

### ورود گروهی محصولات

1. **دریافت لینک دسته‌بندی**
   ```
   # کل دسته‌بندی
   https://www.digikala.com/search/category-mobile-phone/
   
   # برند خاص در دسته‌بندی
   https://www.digikala.com/search/category-mobile-phone/?brands[0]=18
   ```

2. **انتخاب محصولات** از جدول نمایش داده شده

3. **تنظیم پارامترهای عمومی**:
   - گارانتی
   - موجودی پیش‌فرض
   - تنظیمات تصاویر

4. **شروع ورود گروهی** با نمایش پیشرفت لحظه‌ای

### هماهنگ‌سازی قیمت‌ها

#### بروزرسانی خودکار
- اجرا می‌شود: **دو بار در روز**
- محصولات هدف: **تمام محصولات با SKU عددی**
- پشتیبانی: **محصولات متغیر**

#### بروزرسانی دستی
1. مراجعه به صفحه "هماهنگ‌سازی قیمت"
2. کلیک بر روی "شروع بروزرسانی دستی"
3. مشاهده گزارش پیشرفت

## مپینگ داده‌ها

### از دیجی‌کالا به ووکامرس

| فیلد دیجی‌کالا | فیلد ووکامرس | توضیحات |
|----------------|----------------|----------|
| `id` | `_sku` | شناسه محصول |
| `title_fa` | `post_title` | نام محصول |
| `title_en` | `en_pro_name` | نام انگلیسی |
| `brand.title` | `product_brand` | برند محصول |
| `tags[].title` | `product_tag` | تگ‌های محصول |
| `data_layer.item_category*` | `product_cat` | دسته‌بندی‌ها |
| `images.main.url` | Featured Image | تصویر شاخص |
| `images.list` | Gallery | گالری تصاویر |
| `specifications` | `_product_attributes` | مشخصات فنی |
| `variants` | Variable Products | محصولات متغیر |

### فیلدهای سفارشی اضافه شده

```php
// فیلدهای پیش‌فرض اضافه شده
'product_granti_text'    => 'متن گارانتی'
'product_hamta_text'     => 'هشدار همتا'  
'product_Original_text'  => 'ضمانت اصالت'
'product_return_text'    => 'شرایط بازگشت'
'en_pro_name'           => 'نام انگلیسی'
'_mojoodi'              => 'موجودی'
```

## API های استفاده شده

### دریافت اطلاعات محصول
```
GET https://api.digikala.com/v2/product/{product_id}/
```

### دریافت محصولات دسته‌بندی
```
GET https://api.digikala.com/v1/categories/{category}/search/
```

### پارامترهای اختیاری
```
?page=1&rows=20&sort=latest&has_selling_stock=1&brand[]=18
```

## کرون جاب‌ها

### هماهنگ‌سازی قیمت
- **Hook**: `dpi_daily_price_sync`
- **فرکانس**: `twicedaily` (دو بار در روز)
- **عملکرد**: بروزرسانی قیمت محصولات

### پاکسازی فایل‌های موقت
- **Hook**: `dpi_cleanup_temp_files`
- **فرکانس**: `daily` (روزانه)
- **عملکرد**: حذف فایل‌های موقت قدیمی

## مدیریت خطاها

### خطاهای متداول

1. **محصول یافت نشد**
   - علت: ID نامعتبر یا محصول حذف شده
   - راه‌حل: بررسی صحت لینک

2. **خطای شبکه**
   - علت: عدم اتصال به API دیجی‌کالا
   - راه‌حل: بررسی اتصال اینترنت

3. **خطای مجوز**
   - علت: عدم دسترسی کاربر
   - راه‌حل: اطمینان از نقش کاربری مناسب

### لاگ‌گیری
- **محل ذخیره**: جدول `wp_options` با کلید `dpi_activity_logs`
- **حداکثر رکورد**: 100 عدد
- **اطلاعات ثبت شده**: نوع عملیات، پیام، زمان، کاربر

## تنظیمات پیشرفته

### کش (Cache)
- **مدت زمان**: 6 ساعت
- **کلید کش**: `dpi_product_{product_id}`
- **محل ذخیره**: WordPress Transients

### بهینه‌سازی
- **تأخیر بین درخواست‌ها**: 2 ثانیه در ورود گروهی
- **تأخیر هماهنگ‌سازی**: 1 ثانیه بین محصولات
- **حداکثر تصاویر گالری**: 20 عدد

### امنیت
- **Nonce verification** برای تمام درخواست‌های AJAX
- **Capability check** برای دسترسی کاربران
- **Input sanitization** برای تمام ورودی‌ها

## عیب‌یابی

### حالت دیباگ
```php
// افزودن به wp-config.php
define('DPI_DEBUG', true);
```

### بررسی سیستم
```php
// استفاده از تابع helper
$requirements = dpi_check_system_requirements();
if (!empty($requirements)) {
    // نمایش نیازمندی‌های ناقص
}
```

### پاکسازی دستی
```php
// پاک کردن کش‌ها
wp_cache_flush();

// پاک کردن لاگ‌ها
dpi_clear_activity_logs();

// پاک کردن فایل‌های موقت
dpi_cleanup_temp_files();
```

## مجوزها و کپی‌رایت

این افزونه تحت مجوز GPL v2 یا بالاتر منتشر شده است.

**توسعه‌دهنده**: میثم نوبهار  
**ورژن**: 2.0.0  
**آخرین بروزرسانی**: 2025  

## پشتیبانی

برای گزارش باگ‌ها یا درخواست ویژگی‌های جدید، لطفاً با توسعه‌دهنده تماس بگیرید.

---

**نکته**: این افزونه تنها برای استفاده قانونی و در چارچوب قوانین کپی‌رایت طراحی شده است. کاربران مسئول رعایت قوانین مربوطه هستند.